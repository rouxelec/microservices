version: 0.2

phases:
  pre_build:
    commands:
      - echo deploy ec2 helloworld version
      - aws --version
      - DATE=$(date +%s)
      - echo "{\"id\":{\"S\":\"ecs\"},\"when\":{\"S\":\"start\"},\"time\":{\"S\":\"${DATE}\"}}" > date.json
      - aws dynamodb put-item --table-name Deployment --item file://date.json
  build:
    commands:
      - echo Deploy started on `date`
      - echo scaling out the ASG...
      - S3_CONFIG_BUCKET=$(aws ssm get-parameter --name "s3_config_bucket" | jq -r '.Parameter.Value')
      - aws s3 cp --recursive src/ec2/ s3://$S3_CONFIG_BUCKET/temp
      - ASG_NAME=$(aws ssm get-parameter --name "asg_name" | jq -r '.Parameter.Value')
      - aws autoscaling update-auto-scaling-group --auto-scaling-group-name ${ASG_NAME} --desired-capacity 2
  post_build:
    commands:
      - echo Build completed on `date`